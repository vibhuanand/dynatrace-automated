# filename: ansible/roles/dynatrace_activegate/tasks/main.yml
- name: Fail if required env vars missing
  ansible.builtin.fail:
    msg: "DT_TENANT_URL and DT_PAAS_TOKEN must be provided as environment variables."
  when: lookup('env', 'DT_TENANT_URL') == '' or lookup('env', 'DT_PAAS_TOKEN') == ''

- name: Download ActiveGate installer (Linux)
  ansible.builtin.get_url:
    url: "{{ lookup('env','DT_TENANT_URL') }}/api/v1/deployment/installer/gateway/unix/latest?arch=x86&flavor=default"
    dest: /tmp/Dynatrace-ActiveGate.sh
    mode: "0755"
    headers:
      Authorization: "Api-Token {{ lookup('env','DT_PAAS_TOKEN') }}"

- name: Install ActiveGate (silent)
  ansible.builtin.command: >
    /tmp/Dynatrace-ActiveGate.sh --quiet
  args:
    creates: /opt/dynatrace/gateway

- name: Ensure ActiveGate service is running
  ansible.builtin.systemd:
    name: dynatracegateway
    state: started
    enabled: true
